class PlayerElement extends HTMLElement{constructor(){super(),this.id="player"}connectedCallback(){window.APlayer&&window.fetch&&this.parsec()}disconnectedCallback(){this.lock||this.aplayer.destroy()}camelize(e){return e.replace(/^[_.\- ]+/,"").toLowerCase().replace(/[_.\- ]+(\w|$)/g,(e,t)=>t.toUpperCase())}parsec(){let e={};for(let t=0;t<this.attributes.length;t+=1)e[this.camelize(this.attributes[t].name)]=this.attributes[t].value;let t=["baseurl","lrcapi","username","password"];this.meta={};for(let a of t)this.meta[a]=e[a];this.aplayerinit(this.meta)}aplayerinit(e){console.log("\n %c APlayerForNavidrome v1.0 %c https://github.com/maytom2016/aplayerfornavidrome.js\n","color: #fadfa3; background: #030307; padding:5px 0;","background: #fadfa3; padding:5px 0;"),this.authenticate(e).then(t=>(this.keepalive(e.baseurl,t.token,t.id),this.getSongs(e.baseurl,t.token,t.id)).then(a=>{var r=this.makesongjson(a,e,t.subsonicSalt,t.subsonicToken);let s=document.createElement("div");this.appendChild(s);var n=new APlayer({element:s,fixed:!0,order:"list",loop:"all",lrcType:3,audio:r});this.aplayer=n})).catch(e=>{console.error(e)})}async authenticate(e){const t=e.baseurl+"/auth/login",a={username:e.username,password:e.password};try{const e=await fetch(t,{method:"POST",headers:{"Content-Type":"application/json;charset=utf-8","user-agent":"Dart/3.3 (dart:io)"},body:JSON.stringify(a)});if(!e.ok)throw new Error("Network response was not ok: "+e.statusText);const r=await e.json(),s=r.token,n=r.id,o=r.subsonicSalt,i=r.subsonicToken;return{token:s,id:n,subsonicSalt:o,subsonicToken:i}}catch(e){throw console.error("Authentication failed:",e),e}}async keepalive(e,t,a){const r=e+"/api/keepalive/keepalive",s=new Headers({"user-agent":"Dart/3.3 (dart:io)","x-nd-authorization":"Bearer "+t,"accept-encoding":"gzip","x-nd-client-unique-id":+a});fetch(r,{method:"GET",headers:s}).then(e=>{if(!e.ok)throw new Error("Network response was not ok.");return e}).then(e=>e.text()).then(e=>{}).catch(e=>{console.error("Keepalive failed:",e)})}async getSongs(e,t,a){const r=e+"/api/song?_end=500&_order=ASC&_sort=title&_start=0";var s=new Headers({"X-ND-Authorization":"Bearer "+t,"Accept-Encoding":"gzip","X-ND-Client-Unique-Id":a});try{const e=await fetch(r,{method:"GET",headers:s});if(!e.ok)throw new Error("Network response was not ok: "+e.statusText);const t=await e.json(),a=t;return a}catch(e){console.error("Failed to get songs:",e)}}makesongjson(e,t,a,r){for(var s=[],n={},o=0;o<e.length;o++){var i=e[o];n={title:i.title,author:i.artist,url:t.baseurl+"/rest/stream?u="+t.username+"&t="+r+"&s="+a+"&f=json&v=1.15.0&c=Stream+Music&id="+i.id+"&format=raw&maxBitRate=0",pic:t.baseurl+"/rest/getCoverArt?u="+t.username+"&t="+r+"&s="+a+"&f=json&v=1.15.0&c=Stream+Music&id="+i.albumId+"&size=600",lrc:t.lrcapi+"/api/v1/lyrics/single?title="+i.title+"&artist="+i.artist},s.push(n)}return s}}window.customElements&&!window.customElements.get("afn-js")&&(window.PlayerElement=PlayerElement,window.customElements.define("afn-js",PlayerElement));